<!DOCTYPE html>
<html lang="en">
    <head>
      
    
        <meta http-equiv="X-UA-Compatible" content="IE=edge" >
        <meta http-equiv="content-type" content="text/html; charset=utf-8">

        <!-- SEO -->
        
        <title> Classify video using deep learning! | Boom: Stacktrace! </title>
        

        <!-- Enable responsiveness on mobile devices-->
        <meta name="viewport"  content="width=device-width, initial-scale=1.0, maximum-scale=1" >

        <!--  css -->
        <link rel="stylesheet"  href="https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts/ergo.css" >

        <!-- fonts -->
        <!-- preload  -->
        <link rel="preload" href="https://fonts.googleapis.com/css?family=Montserrat:200,300,300i,400,500,500i,600,700,800,900|Raleway" as="style">
        <link rel="preload"  href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" as="style" >
        <!-- load -->
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:200,300,300i,400,500,500i,600,700,800,900|Raleway">
        <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css"  integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous">
      

    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-147236070-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-147236070-1');
</script>
    <meta name="google-site-verification" content="Qji4PNUvSln_XZuENJPHEKMURU6lvBfJqyl9aWoK7RM" />
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-1285079157269590",
    enable_page_level_ads: true
  });
</script>


    </head>

    <body>
      

      
<nav id="overlord" class="overlord" >
  
<figure class="mini_logo ">
    <a href="https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts" style="background-image: url(https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts/img/stacktrace.png)"></a>
</figure>
<h5>
    <a href="https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts">Boom: Stacktrace!</a>
</h5>

</nav>

<section class="post_container">
  <article>
    
      <h1 class="article_title"><a href="https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts&#x2F;video-resnet&#x2F;" id="article_link">Classify video using deep learning!</a></h1>
      
<ul class="frontmatter frontmatter_page" id="frontmatter">
    <li>
        <time class="article_time"  datetime="2019-09-05T11:13:14Z">September 05, 2019</time>
    </li>
    <span class="dotDivider"></span>
    <li> 1626 words </li>
    <span class="dotDivider" ></span>
    <li> 9 min </li>
</ul>

      <h2 id="what-is-video-resnet">What is Video Resnet?</h2>
<p>Video Resnet is a 3D CNN architecture uses residual learning (skip connections). This network perform 3D convolutions over the spatiotemporal video volume. </p>
<p>2D Resnet has shown huge improvements in tasks such as image classification. But video classification, especially action recognition in video is less popular when compared to image classification. </p>
<p>There are several architectures and research papers interested in video classification, or specifically action classification. Some of the great advances over the years in video classification are deeply rooted in advancement in image classification. </p>
<p>Availability of a large scale dataset for video classification is also one reason the earlier research were focused on image classification techniques to achieve results in video classification. Most of the research utilize available small scale action recognition datasets. Earlier techniques explored the possibility of using 2D CNNs trained on ImageNet.</p>
<span id="continue-reading"></span>
<p>Early works ---</p>
<p><strong>&quot;Large-scale Video Classification with Convolutional Neural Networks&quot;</strong> <em>2014</em> - Andrej Karparthy • George Toderici • Sanketh Shetty • Thomas Leung • Rahul Suthankar • Li Fei-Fei (Google Research &amp; Computer Science Department, Stanford University) <a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/42455.pdf">pdf</a></p>
<p>https://cs.stanford.edu/people/karpathy/deepvideo/</p>
<ul>
<li>This paper introduces <code>Sports-1M</code> Dataset. --- An academic dataset which contains 1,133,158 video URLs which have been annotated automatically with 487 labels. The annotation was done via YouTube Topics API. </li>
<li>The paper uses CNN (2D) to classify video using a technique called &quot;Slow fusion&quot; to convolve over the temporal information. And a Multiresolution CNN with a Fovea stream and context stream. </li>
</ul>
<p><strong>&quot;Two-Stream Convolutional Networks for Action Recognition in Videos&quot;</strong> <em>2014</em> Karen Simonyan • Andrew Zisserman (Visual Geometry Group, University of Oxford) <a href="https://papers.nips.cc/paper/5353-two-stream-convolutional-networks-for-action-recognition-in-videos.pdf">pdf</a> [NIPS]</p>
<ul>
<li>This paper introduces optical flow temporal stream input for action recognition.</li>
<li>Two ConvNet are used in the model proposed in this paper.</li>
<li>First ConvNet takes a single RGB frame randomly sampled from the video for Spacial stream. The ConvNet is pretrained in ImageNet.</li>
<li>Second ConvNet takes dense optical flow input. Passed sequentially to the ConvNet. </li>
<li>Finally the outputs from both streams are fed to a <em>class score fusion</em> function. The paper implements an SVM to do this.</li>
</ul>
<p><strong>&quot;Beyond Short Snippets: Deep Networks for Video Classification&quot;</strong> <em>2015</em> Joe Yue-Hei Ng • Matthew Hausknecht • Sudheendra Vijayanarasimhan • Oriol Vinyals • Rajat Monga • George Toderici (University of Maryland, College Park • University of Texas at Austin • Google, Inc.) <a href="https://www.cv-foundation.org/openaccess/content_cvpr_2015/papers/Ng_Beyond_Short_Snippets_2015_CVPR_paper.pdf">pdf</a> [CVPR]</p>
<ul>
<li>This paper explores an approach using a ConvNet(AlexNet or GoogLeNet). The ConvNet output an average pooled 1000 dimentional vector. The 1000 dimentional vector is fed to an LSTM network. The deep LSTM network, in which the output from one LSTM layer is input for the next layer. Uses 5 such stacked layers each with 512 memory cells. The following LSTM layers, a Softmax classifier makes a prediction at every frame.</li>
<li>Data augmentation --- Multiple random crops per video, by randomly selecting the position of the first frame and consistent random crops for each frame during  both training and testing.</li>
<li>Use of optical flow inputs as suggested in <em>&quot;Two-Stream Convolutional Networks for Action Recognition in Videos&quot;</em> by K. Simonyan and A. Zisserman.</li>
</ul>
<p><strong>&quot;Quo Vadis, Action Recognition? A New Model and the Kinetics Dataset&quot;</strong> <em>Feb 2018</em> Joao Carreira • Andrew Zisserman (DeepMind • Depratment of Engineering Science, University of Oxford) <a href="https://arxiv.org/pdf/1705.07750.pdf">pdf</a> [<strong>SOTA</strong>]</p>
<ul>
<li>Introduces Kinetics-700 dataset</li>
<li>Inflated 3D Convolution</li>
</ul>
<p>The focus of this blog post is mainly on the following paper ---</p>
<p><strong>&quot;A Closer Look at Spatiotemporal Convolutions for Action Recognition&quot;</strong> <em>Apr 2018</em> Du Tran • Heng Wang • Lorenzo Torresani • Jamie Ray • Yann LeCun • Manohar Paluri (Facebook Research • Dartmouth College) <a href="https://arxiv.org/pdf/1711.11248.pdf">pdf</a></p>
<ul>
<li>Introduces Residual learning framework into video classification.</li>
<li>Introduces R(2+1)D CNN function which is comparable or superior to I3D(State of the art) function.</li>
</ul>
<p>I will be discussing about the R(2+1)D in the following part of this post.
An 18 layer deep R(2+1)D (VideoResnet) network as in https://arxiv.org/abs/1711.11248</p>
<hr />
<blockquote>
<p><strong>Disclaimer</strong>: In most of this post I am using the paper author's own words to describe what is what. This is done because, I felt my words won't be just to describe what is what. And my purpose of writing this post is to put it all together for myself and others in a way that is easier for me to understand. And probably some of you might find it interesting as well. </p>
</blockquote>
<p>There are 5 residual network architectures being discused in this paper.</p>
<ol>
<li><strong><code>R2D</code></strong> (2D Resnet)</li>
<li><strong><code>MCx</code></strong> (Resnet with mixed convolutions 3D convolutions followed by 2D convolution layers)</li>
<li><strong><code>rMCx</code></strong> (Resnet with mixed convolutions reversed, where 2D convolutions followed by 3D convolution layers)</li>
<li><strong><code>R3D</code></strong> (3D Resnet)</li>
<li><strong><code>R(2+1)D</code></strong> (ResNet with (2+1)D convolutions)</li>
</ol>
<p><em>The architecture:</em></p>
<p><img src="/img/video-resnet/r2plus1d.png" alt="r2plus1d.png" />
R(2+1)D are ResNets with (2+1)D convolutions. The residual connections are not shown in the image.</p>
<h2 id="2-1-d-vs-3d-convolution">(2+1)D vs 3D convolution</h2>
<p><img src="/img/video-resnet/2plus1dConv.png" alt="2plus1dConv.png" />
Consider a video sample with <code>t</code> frames (the temporal extend) and <code>d x d</code> width and height (the spacial width and height) and a single input channel for simplicity.
(a) Full 3D convolution is carried out using a filter of size <code>t x d x d</code>.
(b) A (2+1)D convolution block splits the computation into a spacial 2D convolution followed by a temporal 1D convolution. The spacial convolutions are done using a 3D convolution function with kernel size <code>1 x d x d</code> and number of filters being <code>Mi</code>. Which is the input size to the temporal convolution function. Which is again a 3D convolution function with kernel size <code>t x 1 x 1</code>.</p>
<h2 id="why-are-2-1-d-convolutions-better-than-3d">Why are (2+1)D convolutions better than 3D?</h2>
<p>Following figure shows the training and testing errors on Kinetics for R3D and R(2+1)D, using 18-layers (left) and 34-layers (right).</p>
<p><img src="/img/video-resnet/train_test_r2plus1d_vs_r3d.png" alt="train_test_r2plus1d_vs_r3d.png" />
<strong>Train and test error - R(2+1)D vs. R3D</strong>
ResNets with 18 layers (left) and 34 layers (right). The observation is that the training error is smaller for the R(2+1)D network compared to the R3D network. This is particularly true in case of network with more depth (34 layer network on the right). </p>
<p>Based on this observation the paper suggests that <em>&quot;<strong>the spatial-temporal decomposition implemented by the R(2+1)D eases the optimization, especially as the depth is increased</strong>&quot;.</em> </p>
<hr />
<h2 id="code">Code</h2>
<p>Original source: https://pytorch.org/docs/stable/_modules/torchvision/models/video/resnet.html (slightly modified in this post to reduce unwanted complexity).</p>
<blockquote>
<p>The code part is being worked on, I will update the blog post soon with the code part explained. For the time being following code is working and is tested. </p>
</blockquote>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">torch
</span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">torch.nn </span><span style="color:#b48ead;">as </span><span style="color:#c0c5ce;">nn

</span><span style="color:#b48ead;">from </span><span style="color:#c0c5ce;">torchvision.models.utils </span><span style="color:#b48ead;">import </span><span style="color:#c0c5ce;">load_state_dict_from_url
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#bf616a;">MODEL_URL </span><span style="color:#c0c5ce;">= &#39;</span><span style="color:#a3be8c;">https://download.pytorch.org/models/r2plus1d_18-91a641e6.pth</span><span style="color:#c0c5ce;">&#39;
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">BasicBlock</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">nn.Module</span><span style="color:#eff1f5;">):
    </span><span style="color:#b48ead;">def </span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">(
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, 
        </span><span style="color:#bf616a;">inplanes</span><span style="color:#c0c5ce;">, 
        </span><span style="color:#bf616a;">planes</span><span style="color:#c0c5ce;">, 
        </span><span style="color:#bf616a;">conv_builder</span><span style="color:#c0c5ce;">, 
        </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, 
        </span><span style="color:#bf616a;">downsample</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">None
    </span><span style="color:#c0c5ce;">):
        midplanes = (inplanes * planes * </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">* </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">* </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">) // (inplanes * </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">* </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">3 </span><span style="color:#c0c5ce;">* planes)

        </span><span style="color:#96b5b4;">super</span><span style="color:#c0c5ce;">(BasicBlock, </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">).</span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">()
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.conv1 = nn.</span><span style="color:#bf616a;">Sequential</span><span style="color:#c0c5ce;">(
            </span><span style="color:#bf616a;">conv_builder</span><span style="color:#c0c5ce;">(inplanes, planes, midplanes, stride),
            nn.</span><span style="color:#bf616a;">BatchNorm3d</span><span style="color:#c0c5ce;">(planes),
            nn.</span><span style="color:#bf616a;">ReLU</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">inplace</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">)
        )
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.conv2 = nn.</span><span style="color:#bf616a;">Sequential</span><span style="color:#c0c5ce;">(
            </span><span style="color:#bf616a;">conv_builder</span><span style="color:#c0c5ce;">(planes, planes, midplanes),
            nn.</span><span style="color:#bf616a;">BatchNorm3d</span><span style="color:#c0c5ce;">(planes)
        )
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.relu = nn.</span><span style="color:#bf616a;">ReLU</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">inplace</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">)
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.downsample = downsample
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.stride = stride

    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">forward</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">x</span><span style="color:#c0c5ce;">):
        residual = x

        out = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">conv1</span><span style="color:#c0c5ce;">(x)
        out = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">conv2</span><span style="color:#c0c5ce;">(out)
        </span><span style="color:#b48ead;">if </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.downsample is not </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
            residual = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">downsample</span><span style="color:#c0c5ce;">(x)

        out += residual
        out = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">relu</span><span style="color:#c0c5ce;">(out)

        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">out
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">Conv2Plus1D</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">nn.Sequential</span><span style="color:#eff1f5;">):
    </span><span style="color:#b48ead;">def </span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">(
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">,
        </span><span style="color:#bf616a;">in_planes</span><span style="color:#c0c5ce;">,
        </span><span style="color:#bf616a;">out_planes</span><span style="color:#c0c5ce;">,
        </span><span style="color:#bf616a;">midplanes</span><span style="color:#c0c5ce;">,
        </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">,
        </span><span style="color:#bf616a;">padding</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">1
    </span><span style="color:#c0c5ce;">):
        </span><span style="color:#96b5b4;">super</span><span style="color:#c0c5ce;">(Conv2Plus1D, </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">).</span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">(
            nn.</span><span style="color:#bf616a;">Conv3d</span><span style="color:#c0c5ce;">(in_planes, midplanes, 
                </span><span style="color:#bf616a;">kernel_size</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">),
                </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, stride, stride), 
                </span><span style="color:#bf616a;">padding</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, padding, padding),
                </span><span style="color:#bf616a;">bias</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">False
            </span><span style="color:#c0c5ce;">),
            nn.</span><span style="color:#bf616a;">BatchNorm3d</span><span style="color:#c0c5ce;">(midplanes),
            nn.</span><span style="color:#bf616a;">ReLU</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">inplace</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">),
            nn.</span><span style="color:#bf616a;">Conv3d</span><span style="color:#c0c5ce;">(midplanes, out_planes, 
                </span><span style="color:#bf616a;">kernel_size</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">),
                </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=(stride, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">),
                </span><span style="color:#bf616a;">padding</span><span style="color:#c0c5ce;">=(padding, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">),
                </span><span style="color:#bf616a;">bias</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">False
            </span><span style="color:#c0c5ce;">)
        )
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">R2Plus1dStem</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">nn.Sequential</span><span style="color:#eff1f5;">):
    </span><span style="color:#b48ead;">def </span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">):
        </span><span style="color:#96b5b4;">super</span><span style="color:#c0c5ce;">(R2Plus1dStem, </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">).</span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">(
            nn.</span><span style="color:#bf616a;">Conv3d</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">45</span><span style="color:#c0c5ce;">, 
                    </span><span style="color:#bf616a;">kernel_size</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">7</span><span style="color:#c0c5ce;">),
                    </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">), 
                    </span><span style="color:#bf616a;">padding</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">),
                    </span><span style="color:#bf616a;">bias</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">False
            </span><span style="color:#c0c5ce;">),
            nn.</span><span style="color:#bf616a;">BatchNorm3d</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">45</span><span style="color:#c0c5ce;">),
            nn.</span><span style="color:#bf616a;">ReLU</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">inplace</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">),
            nn.</span><span style="color:#bf616a;">Conv3d</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">45</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">,
                    </span><span style="color:#bf616a;">kernel_size</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">),
                    </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">), </span><span style="color:#bf616a;">padding</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">),
                    </span><span style="color:#bf616a;">bias</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">False
            </span><span style="color:#c0c5ce;">),
            nn.</span><span style="color:#bf616a;">BatchNorm3d</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">),
            nn.</span><span style="color:#bf616a;">ReLU</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">inplace</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">)
        )    
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">R2Plus1D18</span><span style="color:#eff1f5;">(</span><span style="color:#a3be8c;">nn.Module</span><span style="color:#eff1f5;">):
    </span><span style="color:#b48ead;">def </span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">num_classes</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">400</span><span style="color:#c0c5ce;">):
        </span><span style="color:#65737e;">&quot;&quot;&quot;
        R(2+1)D VideoResNet
        Args:
            num_classes (int, optional): Dimension of the final FC layer. Defaults to 400.
        &quot;&quot;&quot;
        </span><span style="color:#96b5b4;">super</span><span style="color:#c0c5ce;">(R2Plus1D18, </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">).</span><span style="color:#96b5b4;">__init__</span><span style="color:#c0c5ce;">()
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.stem = </span><span style="color:#bf616a;">R2Plus1dStem</span><span style="color:#c0c5ce;">()

        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.layer1 = nn.</span><span style="color:#bf616a;">Sequential</span><span style="color:#c0c5ce;">(
            </span><span style="color:#bf616a;">BasicBlock</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">, Conv2Plus1D),
            </span><span style="color:#bf616a;">BasicBlock</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">, Conv2Plus1D)
        )

        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.layer2 = nn.</span><span style="color:#bf616a;">Sequential</span><span style="color:#c0c5ce;">(
            </span><span style="color:#bf616a;">BasicBlock</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">128</span><span style="color:#c0c5ce;">, Conv2Plus1D, 
                </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, 
                </span><span style="color:#bf616a;">downsample</span><span style="color:#c0c5ce;">=</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">_get_downsample</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">64</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">128</span><span style="color:#c0c5ce;">)
            ),
            </span><span style="color:#bf616a;">BasicBlock</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">128</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">128</span><span style="color:#c0c5ce;">, Conv2Plus1D)
        )

        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.layer3 = nn.</span><span style="color:#bf616a;">Sequential</span><span style="color:#c0c5ce;">(
            </span><span style="color:#bf616a;">BasicBlock</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">128</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">, Conv2Plus1D, 
                </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, 
                </span><span style="color:#bf616a;">downsample</span><span style="color:#c0c5ce;">=</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">_get_downsample</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">128</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">)
            ),
            </span><span style="color:#bf616a;">BasicBlock</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">, Conv2Plus1D)
        )

        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.layer4 = nn.</span><span style="color:#bf616a;">Sequential</span><span style="color:#c0c5ce;">(
            </span><span style="color:#bf616a;">BasicBlock</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">512</span><span style="color:#c0c5ce;">, Conv2Plus1D, 
                </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, 
                </span><span style="color:#bf616a;">downsample</span><span style="color:#c0c5ce;">=</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">_get_downsample</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">256</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">512</span><span style="color:#c0c5ce;">)
            ),
            </span><span style="color:#bf616a;">BasicBlock</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">512</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">512</span><span style="color:#c0c5ce;">, Conv2Plus1D)
        )

        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.avgpool = nn.</span><span style="color:#bf616a;">AdaptiveAvgPool3d</span><span style="color:#c0c5ce;">((</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">))
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.fc = nn.</span><span style="color:#bf616a;">Linear</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">512</span><span style="color:#c0c5ce;">, num_classes)

        </span><span style="color:#65737e;"># init weights
        </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">_initialize_weights</span><span style="color:#c0c5ce;">()

    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">forward</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">x</span><span style="color:#c0c5ce;">):
        x = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">stem</span><span style="color:#c0c5ce;">(x)

        x = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">layer1</span><span style="color:#c0c5ce;">(x)
        x = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">layer2</span><span style="color:#c0c5ce;">(x)
        x = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">layer3</span><span style="color:#c0c5ce;">(x)
        x = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">layer4</span><span style="color:#c0c5ce;">(x)

        x = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">avgpool</span><span style="color:#c0c5ce;">(x)
        </span><span style="color:#65737e;"># Flatten the layer to fc
        </span><span style="color:#c0c5ce;">x = x.</span><span style="color:#bf616a;">flatten</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)
        x = </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">fc</span><span style="color:#c0c5ce;">(x)

        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">x

    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">_get_downsample</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">inplane</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">outplane</span><span style="color:#c0c5ce;">):
        </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">nn.</span><span style="color:#bf616a;">Sequential</span><span style="color:#c0c5ce;">(
            nn.</span><span style="color:#bf616a;">Conv3d</span><span style="color:#c0c5ce;">(
                inplane, outplane, 
                </span><span style="color:#bf616a;">kernel_size</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, 
                </span><span style="color:#bf616a;">stride</span><span style="color:#c0c5ce;">=(</span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">2</span><span style="color:#c0c5ce;">), 
                </span><span style="color:#bf616a;">bias</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">False
            </span><span style="color:#c0c5ce;">),
            nn.</span><span style="color:#bf616a;">BatchNorm3d</span><span style="color:#c0c5ce;">(outplane)
        )

    </span><span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">_initialize_weights</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">):
        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">m </span><span style="color:#b48ead;">in </span><span style="color:#bf616a;">self</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">modules</span><span style="color:#c0c5ce;">():
            </span><span style="color:#b48ead;">if </span><span style="color:#96b5b4;">isinstance</span><span style="color:#c0c5ce;">(m, nn.Conv3d):
                nn.init.</span><span style="color:#bf616a;">kaiming_normal_</span><span style="color:#c0c5ce;">(m.weight, </span><span style="color:#bf616a;">mode</span><span style="color:#c0c5ce;">=&#39;</span><span style="color:#a3be8c;">fan_out</span><span style="color:#c0c5ce;">&#39;,
                                        </span><span style="color:#bf616a;">nonlinearity</span><span style="color:#c0c5ce;">=&#39;</span><span style="color:#a3be8c;">relu</span><span style="color:#c0c5ce;">&#39;)
                </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">m.bias is not </span><span style="color:#d08770;">None</span><span style="color:#c0c5ce;">:
                    nn.init.</span><span style="color:#bf616a;">constant_</span><span style="color:#c0c5ce;">(m.bias, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
            </span><span style="color:#b48ead;">elif </span><span style="color:#96b5b4;">isinstance</span><span style="color:#c0c5ce;">(m, nn.BatchNorm3d):
                nn.init.</span><span style="color:#bf616a;">constant_</span><span style="color:#c0c5ce;">(m.weight, </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)
                nn.init.</span><span style="color:#bf616a;">constant_</span><span style="color:#c0c5ce;">(m.bias, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
            </span><span style="color:#b48ead;">elif </span><span style="color:#96b5b4;">isinstance</span><span style="color:#c0c5ce;">(m, nn.Linear):
                nn.init.</span><span style="color:#bf616a;">normal_</span><span style="color:#c0c5ce;">(m.weight, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">0.01</span><span style="color:#c0c5ce;">)
                nn.init.</span><span style="color:#bf616a;">constant_</span><span style="color:#c0c5ce;">(m.bias, </span><span style="color:#d08770;">0</span><span style="color:#c0c5ce;">)
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#b48ead;">def </span><span style="color:#8fa1b3;">r2plus1d_18</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">pretrained</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">False</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">progress</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">, **</span><span style="color:#bf616a;">kwargs</span><span style="color:#c0c5ce;">):
    model = </span><span style="color:#bf616a;">R2Plus1D18</span><span style="color:#c0c5ce;">(**kwargs)

    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">pretrained:
        state_dict = </span><span style="color:#bf616a;">load_state_dict_from_url</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">MODEL_URL</span><span style="color:#c0c5ce;">,
                                              </span><span style="color:#bf616a;">progress</span><span style="color:#c0c5ce;">=progress)
        model.</span><span style="color:#bf616a;">load_state_dict</span><span style="color:#c0c5ce;">(state_dict)
    </span><span style="color:#b48ead;">return </span><span style="color:#c0c5ce;">model
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">model = </span><span style="color:#bf616a;">r2plus1d_18</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">pretrained</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">, </span><span style="color:#bf616a;">progress</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">True</span><span style="color:#c0c5ce;">)
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#65737e;"># Detect devices
</span><span style="color:#c0c5ce;">use_cuda = torch.cuda.</span><span style="color:#bf616a;">is_available</span><span style="color:#c0c5ce;">()
device = torch.</span><span style="color:#bf616a;">device</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">cuda</span><span style="color:#c0c5ce;">&quot; </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">use_cuda </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">cpu</span><span style="color:#c0c5ce;">&quot;)
</span></pre>
<p>Let's run it!</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">X = torch.</span><span style="color:#bf616a;">randn</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">3</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">8</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">112</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">112</span><span style="color:#c0c5ce;">)

model, X = model.</span><span style="color:#bf616a;">to</span><span style="color:#c0c5ce;">(device), X.</span><span style="color:#bf616a;">to</span><span style="color:#c0c5ce;">(device)

y_ = </span><span style="color:#bf616a;">model</span><span style="color:#c0c5ce;">(X)
</span></pre><pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">torch.</span><span style="color:#bf616a;">argmax</span><span style="color:#c0c5ce;">(torch.</span><span style="color:#bf616a;">softmax</span><span style="color:#c0c5ce;">(y_, </span><span style="color:#bf616a;">dim</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">), </span><span style="color:#bf616a;">dim</span><span style="color:#c0c5ce;">=</span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">)
</span></pre>
<p>Output: <code>tensor([316], device='cuda:0')</code></p>

      
  </article>
</section>

       

      <footer>
        
          
<figure class="mini_logo ">
    <a href="https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts" style="background-image: url(https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts/img/stacktrace.png)"></a>
</figure>
<h5>
    <a href="https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts">Boom: Stacktrace!</a>
</h5>

          
<ul class="social_list foot_list" >
    
    
    <li class="button extra_small font_faint"><a href="https://github.com/aslamplr" target="_blank" >aslamplr</a><i class="fab fa-github" ></i></li>
    
    
    <li class="button extra_small font_faint"><a href="https://twitter.com/aslamplr" target="_blank">@aslamplr</a><i class="fab fa-twitter" ></i></li>
    
    
    
    
    
    
    
    <li class="button extra_small font_faint"><a href="mailto:aslamplr+code-blog@gmail.com?subject=hi" target="_blank">say hello</a><i class="fas fa-envelope" ></i></li>
    
    
    <li class="button extra_small font_faint"><a href="https:&#x2F;&#x2F;aslamplr.github.io&#x2F;drafts/rss.xml" target ="_blank">rss</a><i class="fas fa-rss" ></i></li>
    
</ul>

        
      </footer>
    </body>
</html>
